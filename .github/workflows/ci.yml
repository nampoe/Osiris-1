name: ci
on:
  workflow_dispatch:
  push:
    branches:
      - '**'
jobs:
  windows-msbuild:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
        toolset: [ClangCL, MSVC]
        configuration: [Debug, Release]
    steps:
    - uses: actions/checkout@v4
    - name: add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
    - name: set toolset
      if: matrix.toolset == 'ClangCL'
      run: echo "toolset=/p:PlatformToolset=${{ matrix.toolset }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
    - name: Build
      shell: cmd
      run: msbuild Osiris.sln /p:Platform=x64 /p:Configuration=${{ matrix.configuration }} ${{ env.toolset }}
    - name: prepare artifacts
      shell: pwsh
      run: |
        $cfg = "${{ matrix.configuration }}".ToLower()
        $ts  = "${{ matrix.toolset }}".ToLower()
        $out = "dist"
        New-Item -ItemType Directory -Force -Path $out | Out-Null
        
        $dll = Get-ChildItem "x64/${{ matrix.configuration }}/*.dll" | Select-Object -First 1
        $pdb = Get-ChildItem "x64/${{ matrix.configuration }}/*.pdb" | Select-Object -First 1
        
        if (-not $dll) { throw "DLL not found" }
        
        if ($cfg -eq "debug") {
          if (-not $pdb) { throw "PDB not found" }
          Compress-Archive -Path $dll.FullName, $pdb.FullName `
                           -DestinationPath "$out/windows-$cfg-$ts.zip" -Force
        }
        else {
          Copy-Item $dll "$out/windows-$cfg-$ts.dll"
        }
    - name: upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ runner.os }}-${{ matrix.configuration }}-${{ matrix.toolset || matrix.compiler }}
        path: dist/*
  

  linux-cmake:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [g++-14, clang++-21]
        configuration: [Debug, Release]
    steps:
    - uses: actions/checkout@v4

    - name: install recent LLVM
      if: startsWith(matrix.compiler, 'clang++-')
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh ${{ endsWith(matrix.compiler, '21') && 21 }}

    - name: install dependencies
      run: |
        sudo apt update
        sudo apt install -y cmake ninja-build ${{ startsWith(matrix.compiler, 'g++') && matrix.compiler || '' }}

    - name: configure
      run: CXX=${{ matrix.compiler }} cmake -Werror=dev -DCMAKE_BUILD_TYPE=${{ matrix.configuration }} -DENABLE_TESTS="unit;functional" -DCMAKE_COMPILE_WARNING_AS_ERROR=1 -DCMAKE_UNITY_BUILD=ON -DCMAKE_UNITY_BUILD_BATCH_SIZE=4 -G Ninja -B build

    - name: build source
      run: cmake --build build --target Osiris -j $(nproc)

    - name: build unit tests
      run: cmake --build build --target UnitTests -j $(nproc)

    - name: build functional tests
      run: cmake --build build --target FunctionalTests -j $(nproc)

    - name: prepare artifacts
      run: |
        cfg=$(echo "${{ matrix.configuration }}" | tr A-Z a-z)
        cc=$(echo "${{ matrix.compiler }}" | sed 's/++.*//')
        out=dist
        mkdir -p "$out"
    
        so=$(find build -type f -name "*.so" | head -n1)
        if [ -z "$so" ]; then
          echo "ERROR: .so not found"
          find build
          exit 1
        fi
    
        cp "$so" "$out/linux-$cfg-$cc.so"
        
    - name: upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ runner.os }}-${{ matrix.configuration }}-${{ matrix.toolset || matrix.compiler }}
        path: dist/*
  
  release:
      needs: [linux-cmake, windows-msbuild]
      runs-on: ubuntu-latest
      if: github.ref_type == 'branch'
      steps:
        - uses: actions/checkout@v4
        - uses: actions/download-artifact@v4
          with:
            path: artifacts/
            pattern: '*'
  
        - name: Create / Update rolling draft
          uses: softprops/action-gh-release@v2
          with:
            tag_name:     nightly
            name:         Nightly ${{ github.ref_name }} ${{ github.sha }}
            body:         Built from ${{ github.sha }}
            draft:        false
            prerelease:   true
            files:        artifacts/**/*
            fail_on_unmatched_files: false
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
